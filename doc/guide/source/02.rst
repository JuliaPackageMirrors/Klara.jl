.. _states:

Variable States
==========================================================================================

.. _rationale:

Rationale behind states
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

Being geared towards statistics, ``Lora`` variables include parameters, data, transformations and constants, the specifics of
which will be delineated in the next chapter. A variable, be it stochastic or deterministic, can take a value, that is it
can have a *state*. Variables and their states are maintained in two distinct type systems in ``Lora``.

The functionality of a variable is enclosed by its type instance. For a example, a typical parameter consists of its
probability distribution, log-likelihood or log-prior fields.

It is possible to store the value of a multivariate variable in a vector. However, it might be required to save additional
information. For example, the value of a parameter's log-likelihood and associated gradient might be of interest. Variable
state types exist to accommodate such states that comprise two or more entities.

From an object-oriented programming (OOP) standpoint, variable types correspond to methods while variable state types
constitute data members. ``Lora`` does not merge the functional and data components into a single type, which would had been
the analogous of a class in OOP terms. The main reasoning behind Lora's compartmentalization of variables and their states is
code reusability. For instance, it becomes possible for different variables to share the same state type; more generally,
adhering to Julia's multiple dispatch is facilitated.

Moreover, keeping states separate from variables helps cater to user-specific problems. Existing functionality can be
deployed on user-defined states tailored to the problem at hand.

.. _builtin_states:

Built-in states
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

The state type system comprises two abstract and other non-abstract types. :numref:`_builtin_states_listing` displays the
hierarchy of built-in state types. The two abstract types are ``VariableState`` and its sub-type ``ParameterState``. The
non-abstract states put forward sensible defaults aimed at covering conventional use-cases. ``Lora``’s existing functionality
relies on these defaults, yet it is possible to extend the package by defining custom state types.

Variable states are categorized as univariate or multivariate. Parameter states are further classified as discrete or
continuous. To make these distinctions, parametric abstract state types are employed by importing the ``VariateForm`` and
``ValueSupport`` classification scheme from ``Distributions``. Every possible category is designated a unique non-abstract
state type; for instance, ``BasicContMuvParameterState`` hosts a continuous multivariate parameter state.

The most common field, appearing in all built-in non-abstract state types, is called ``value``. For example, in the context
of MCMC, ``value`` would hold the current or proposed state at each iteration of the sampler. Each state type and its
associated methods will be elaborated in the following sections.

.. code-block:: none
  :name: _builtin_states_listing
  :caption: State type hierarchy in ``Lora``

  VariableState
  |
  +-- BasicUnvVariableState
  |
  +-- BasicMuvVariableState
  |
  +-- BasicMavVariableState
  |    
  +-- ParameterState
      |  
      +-- BasicDiscUnvParameterState
      |
      +-- BasicDiscMuvParameterState
      |
      +-- BasicContUnvParameterState
      |
      +-- BasicContMuvParameterState

.. _abstract_states:

Abstract states
++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++

The type system of ``VariateForm`` and ``ValueSupport`` from ``Distributions``
(see :numref:`_variateform_valuesupport_types` and associated
`documentation <http://distributionsjl.readthedocs.io/en/latest/types.html>`_ in ``Distributions``) is used for
parameterizing abstract states in ``Lora``.

.. code-block:: julia
  :name: _variateform_valuesupport_types
  :caption: ``VariateForm`` and ``ValueSupport`` type system from ``Distributions`` package
  
  abstract VariateForm
  type Univariate    <: VariateForm end
  type Multivariate  <: VariateForm end
  type Matrixvariate <: VariateForm end

  abstract ValueSupport
  type Discrete   <: ValueSupport end
  type Continuous <: ValueSupport end

``VariableState`` is the root of ``Lora``’s variable state type hierarchy. It is defined as

.. code-block:: julia

  abstract VariableState{F<:VariateForm}

Being parameterized by ``VariateForm``, the abstract type ``VariableState`` enables distinguishing between univariate,
multivariate and matrix-variate variable states.

``ParameterState`` is the root of ``Lora``’s parameter state types and an abstract sub-type of ``VariableState``. It is
defined as

.. code-block:: julia

  abstract ParameterState{S<:ValueSupport, F<:VariateForm} <: VariableState{F}

As seen from its parameterization, ``ParameterState`` makes it possible to organize parameter states by both the support of
state space and the variate form.

.. _basic_variable_states:

Basic variable states
++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++

``Lora`` ships with three so-called basic variable state types, namely ``BasicUnvVariableState``, ``BasicMuvVariableState``
and ``BasicMavVariableState``. These three types are used for encapsulating minimal information, that is the ``value`` of a
variable state and possibly the associated ``size`` of ``value``.

Each of these three basic state types corresponds to a specific variate form, whereas none of them is parameterized by the
support of state space. Instead, each of them is parameterized by the type of ``Number`` of their ``value`` field, see
:numref:`_my_table`.

.. table:: Basic variable states in ``Lora``
   :name: _my_table
   
   +--------------------------------------+----------------+---------------------+
   | State type                           | ``value`` type | ``size`` type       |
   +======================================+================+=====================+
   | ``BasicUnvVariableState{N<:Number}`` | ``N``          |                     |
   +--------------------------------------+----------------+---------------------+
   | ``BasicMuvVariableState{N<:Number}`` | ``Vector{N}``  | ``Int``             |
   +--------------------------------------+----------------+---------------------+
   | ``BasicMavVariableState{N<:Number}`` | ``Matrix{N}``  | ``Tuple{Int, Int}`` |
   +--------------------------------------+----------------+---------------------+

In what follows, constructors are provided for the three basic variable types.

BasicUnvVariableState
------------------------------------------------------------------------------------------

.. function:: BasicUnvVariableState{N<:Number}(value::N)

   Construct a basic univariate variable state with some ``value``.
   
   Examples
   
   .. code-block:: julia
   
     state = BasicUnvVariableState(1.)
     # Lora.BasicUnvVariableState{Float64}(1.0)
     
     state.value
     # 1.0
     
BasicMuvVariableState
------------------------------------------------------------------------------------------

.. function:: BasicMuvVariableState{N<:Number}(value::Vector{N})

   Construct a basic multivariate variable state with some ``value``.
   
   Examples
   
   .. code-block:: julia
   
     state = BasicMuvVariableState([1, 2])
     # Lora.BasicMuvVariableState{Int64}([1,2], 2)
     
     state.value
     #  2-element Array{Int64,1}:
     #   1
     #   2
     
     state.size
     # 2

.. function:: BasicMuvVariableState{N<:Number}(size::Int, ::Type{N}=Float64)

   Construct a basic multivariate variable state with a ``value`` of specified ``size`` and element type.
   
   Examples
   
   .. code-block:: julia
   
     BasicMuvVariableState(3, Float32)
     # Lora.BasicMuvVariableState{Float32}(Float32[8.06805f-37,1.0f-45], 2)
    
BasicMavVariableState
------------------------------------------------------------------------------------------

.. function:: BasicMavVariableState{N<:Number}(value::Matrix{N})

   Construct a basic matrix-variate variable state with some ``value``.
   
   Examples
   
   .. code-block:: julia
   
     state = BasicMavVariableState(eye(2))
     # Lora.BasicMavVariableState{Float64}(2x2 Array{Float64, 2}, (2, 2))
     
     state.value
     #  2x2 Array{Float64,2}:
     #   1.0  0.0
     #   0.0  1.0
      
     state.size
     # (2, 2)

.. function:: BasicMavVariableState{N<:Number}(size::Tuple, ::Type{N}=Float64)

   Construct a basic matrix-variate variable state with a ``value`` of specified ``size`` and element type.
   
   Examples
   
   .. code-block:: julia
   
     BasicMavVariableState((3, 2), Int16)
     # Lora.BasicMavVariableState{Int16}(3x2 Array{Int16, 2}, (3, 2))
    